apiVersion: apps/v1
kind: Deployment
metadata:
  name: meshroom-coordinator-demo
  namespace: meshroom
  labels:
    app: meshroom
    component: coordinator-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: meshroom
      component: coordinator-demo
  template:
    metadata:
      labels:
        app: meshroom
        component: coordinator-demo
    spec:
      containers:
      - name: coordinator
        image: redis:7-alpine
        command: ["/bin/sh"]
        args: ["-c", "echo 'ðŸŽ¯ MESHROOM COORDINATOR STARTED ON NODE:' $NODE_NAME && echo 'Pod: $POD_NAME' && echo 'Redis version:' && redis-server --version && echo 'Ready to coordinate distributed processing!' && while true; do echo '[' $(date) '] ðŸ“Š Coordinator heartbeat from node $NODE_NAME'; sleep 60; done"]
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: meshroom-workers-demo
  namespace: meshroom
  labels:
    app: meshroom
    component: worker-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: meshroom
      component: worker-demo
  template:
    metadata:
      labels:
        app: meshroom
        component: worker-demo
    spec:
      containers:
      - name: worker
        image: redis:7-alpine
        command: ["/bin/sh"]
        args: ["-c", "echo 'ðŸš€ MESHROOM WORKER STARTED' && echo 'Node: $NODE_NAME' && echo 'Pod: $POD_NAME' && echo 'Redis tools available for processing coordination' && echo '' && echo 'ðŸ“· Simulating distributed photogrammetry...' && count=1 && while true; do echo '[' $(date) '] Step $count: Processing on node $NODE_NAME (Worker ready for tasks)'; count=$((count+1)); sleep 45; done"]
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      # Ensure workers run on different nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: component
                  operator: In
                  values:
                  - worker-demo
              topologyKey: kubernetes.io/hostname
---
apiVersion: v1
kind: Service
metadata:
  name: meshroom-coordinator-service
  namespace: meshroom
  labels:
    app: meshroom
    component: coordinator-demo
spec:
  selector:
    app: meshroom
    component: coordinator-demo
  ports:
  - name: coordinator
    port: 6379
    targetPort: 6379
  type: ClusterIP


